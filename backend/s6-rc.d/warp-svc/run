#!/bin/sh
# Cloudflare warp-svc can be very noisy in container stdout.
# Keep docker logs clean by default and write daemon logs to file instead.

LOG_MODE="${WARP_SVC_LOG_MODE:-file}"   # file | stdout | silent
LOG_FILE="${WARP_SVC_LOG_FILE:-/var/log/warp-svc.log}"
LOG_MAX_BYTES="${WARP_SVC_LOG_MAX_BYTES:-10485760}"       # 10 MiB
LOG_KEEP_FILES="${WARP_SVC_LOG_KEEP_FILES:-5}"            # keep N rotated files
LOG_CHECK_INTERVAL="${WARP_SVC_LOG_CHECK_INTERVAL:-30}"   # seconds

# Use a dedicated env key for warp-svc verbosity to avoid accidental global overrides.
export RUST_LOG="${WARP_SVC_RUST_LOG:-warn}"

is_positive_int() {
  case "$1" in
    ''|*[!0-9]*) return 1 ;;
    *) [ "$1" -gt 0 ] 2>/dev/null ;;
  esac
}

rotate_logs_copytruncate() {
  [ -f "${LOG_FILE}" ] || return 0

  # Shift archives: .(n-1) -> .n ... .1 -> .2
  i=$((LOG_KEEP_FILES - 1))
  while [ "$i" -ge 1 ]; do
    if [ -f "${LOG_FILE}.${i}" ]; then
      mv -f "${LOG_FILE}.${i}" "${LOG_FILE}.$((i + 1))"
    fi
    i=$((i - 1))
  done

  # copy-truncate keeps the same inode so warp-svc can continue writing safely.
  cp "${LOG_FILE}" "${LOG_FILE}.1" 2>/dev/null || true
  : > "${LOG_FILE}"
}

monitor_log_size() {
  svc_pid="$1"
  while kill -0 "${svc_pid}" 2>/dev/null; do
    if [ -f "${LOG_FILE}" ]; then
      current_size=$(wc -c < "${LOG_FILE}" 2>/dev/null || echo 0)
      if [ "${current_size}" -ge "${LOG_MAX_BYTES}" ] 2>/dev/null; then
        rotate_logs_copytruncate
      fi
    fi
    sleep "${LOG_CHECK_INTERVAL}"
  done
}

case "${LOG_MODE}" in
  stdout)
    exec /usr/bin/warp-svc
    ;;
  silent)
    exec /usr/bin/warp-svc >/dev/null 2>&1
    ;;
  file|*)
    is_positive_int "${LOG_MAX_BYTES}" || LOG_MAX_BYTES=10485760
    is_positive_int "${LOG_KEEP_FILES}" || LOG_KEEP_FILES=5
    is_positive_int "${LOG_CHECK_INTERVAL}" || LOG_CHECK_INTERVAL=30

    mkdir -p "$(dirname "${LOG_FILE}")"
    touch "${LOG_FILE}"

    /usr/bin/warp-svc >>"${LOG_FILE}" 2>&1 &
    svc_pid="$!"

    monitor_log_size "${svc_pid}" &
    monitor_pid="$!"

    wait "${svc_pid}"
    exit_code="$?"

    kill "${monitor_pid}" 2>/dev/null || true
    wait "${monitor_pid}" 2>/dev/null || true

    exit "${exit_code}"
    ;;
esac
